/*! For license information please see 919.js.LICENSE.txt */
"use strict";(self.webpackChunkinqviz_excel=self.webpackChunkinqviz_excel||[]).push([[919],{28721:function(e,t,r){r.d(t,{Z:function(){return l}});var a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let n;const i=new Uint8Array(16);function s(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(i)}const o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));var l=function(e,t,r){if(a.randomUUID&&!t&&!e)return a.randomUUID();const n=(e=e||{}).random||(e.rng||s)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=n[e];return t}return function(e,t=0){return o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]}(n)}},16515:function(e,t,r){r.d(t,{E:function(){return s}});var a=r(28721),n=r(36141);class i{}class s extends i{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,n.j)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"undefined"==typeof process||"true"!==process.env?.LANGCHAIN_CALLBACKS_BACKGROUND}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return n.i.prototype.toJSON.call(this)}toJSONNotImplemented(){return n.i.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends s{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a.Z()}),Object.assign(this,e)}}}}},75290:function(e,t,r){r.d(t,{Ye:function(){return q},QH:function(){return H}});var a=r(28721),n=r(16515),i=r(50265),s=r(84075);function o(e,t){return`${e.open}${t}${e.close}`}function l(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function c(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:d}=i;class u extends s.Z{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,r)=>{const a=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?o(i.bold,a):a})).join(" > ");return o(d.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.green,"[chain/start]")} [${t}] Entering Chain run with input: ${l(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[chain/end]")} [${t}] [${c(e)}] Exiting Chain run with output: ${l(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[chain/error]")} [${t}] [${c(e)}] Chain run errored with error: ${l(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${o(d.green,"[llm/start]")} [${t}] Entering LLM run with input: ${l(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[llm/end]")} [${t}] [${c(e)}] Exiting LLM run with output: ${l(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[llm/error]")} [${t}] [${c(e)}] LLM run errored with error: ${l(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[tool/end]")} [${t}] [${c(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[tool/error]")} [${t}] [${c(e)}] Tool run errored with error: ${l(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${l(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[retriever/end]")} [${t}] [${c(e)}] Exiting Retriever run with output: ${l(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[retriever/error]")} [${t}] [${c(e)}] Retriever run errored with error: ${l(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${o(d.blue,"[agent/action]")} [${r}] Agent selected action: ${l(t.actions[t.actions.length-1],"[action]")}`)}}var h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,p=r(42693),m=r(45860);const f=[400,401,403,404,405,406,407,408,409];class g{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t=m.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>p((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status;if(t&&f.includes(+t))throw e},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function w(e){return"function"==typeof e?._getType}function b(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}const y=()=>"undefined"!=typeof Deno;let _,v;async function E(){if(void 0===_){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||y()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":y()?"deno":"other":"node",e})(),t=function(){if(void 0!==v)return v;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=O(r);void 0!==e&&(t[r]=e)}return v=t,t}();_={library:"langsmith",runtime:e,...t}}return _}function O(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}const T=e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t},S=async(e,t)=>{const r=await e.text();if(!e.ok)throw new Error(`Failed to ${t}: ${e.status} ${e.statusText} ${r}`)};function A(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function j(e){return"true"===O("LANGCHAIN_HIDE_INPUTS")?{}:e}function P(e){return"true"===O("LANGCHAIN_HIDE_OUTPUTS")?{}:e}function I(e){if("string"!=typeof(t=e)||!h.test(t))throw new Error(`Invalid UUID: ${e}`);var t}class R{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null});const t=R.getDefaultClientConfig();this.apiUrl=A(e.apiUrl??t.apiUrl)??"",this.apiKey=A(e.apiKey??t.apiKey),this.webUrl=A(e.webUrl??t.webUrl),this.validateApiKeyIfHosted(),this.timeout_ms=e.timeout_ms??4e3,this.caller=new g(e.callerOptions??{})}static getDefaultClientConfig(){const e=O("LANGCHAIN_API_KEY");return{apiUrl:O("LANGCHAIN_ENDPOINT")??(e?"https://api.smith.langchain.com":"http://localhost:1984"),apiKey:e,webUrl:void 0}}validateApiKeyIfHosted(){if(!T(this.apiUrl)&&!this.apiKey)throw new Error("API key must be provided when using hosted LangSmith API")}getHostUrl(){return this.webUrl?this.webUrl:T(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}async _getResponse(e,t){const r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,n=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to fetch ${e}: ${n.status} ${n.statusText}`);return n}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));const n=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const s=await i.json();if(0===s.length)break;if(yield s,s.length<a)break;r+=s.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let n=t?{...t}:{};for(;;){const t=await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(n)}),i=await t.json();if(!i)break;if(!i[a])break;yield i[a];const s=i.cursors;if(!s)break;if(!s.next)break;n.cursor=s.next}}async createRun(e){const t={...this.headers,"Content-Type":"application/json"},r=e.extra??{},a=await E(),n=e.project_name;delete e.project_name;const i={session_name:n,...e,extra:{...e.extra,runtime:{...a,...r.runtime}}};i.inputs=j(i.inputs),i.outputs&&(i.outputs=P(i.outputs));const s=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms)});await S(s,"create run")}async updateRun(e,t){I(e),t.inputs&&(t.inputs=j(t.inputs)),t.outputs&&(t.outputs=P(t.outputs));const r={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await S(a,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){I(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:O("LANGCHAIN_PROJECT")||"default"})).id;const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const r of e)t.push(r);return t}(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in r||(r[e.parent_run_id]=[]),r[e.parent_run_id].push(e),a[e.id]=e}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(a[t].child_runs=r[t]);return e}async*listRuns({projectId:e,projectName:t,parentRunId:r,referenceExampleId:a,startTime:n,executionOrder:i,runType:s,error:o,id:l,query:c,filter:d,limit:u}){let h=e;if(t){if(e)throw new Error("Only one of projectId or projectName may be given");h=(await this.readProject({projectName:t})).id}const p={session:h?[h]:null,run_type:s,reference_example:a,query:c,filter:d,execution_order:i,parent_run:r?[r]:null,start_time:n?n.toISOString():null,error:o,id:l,limit:u};for await(const e of this._getCursorPaginatedList("/runs",p))yield*e}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||a.Z()};I(e);const n=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)}),i=await n.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){I(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await S(t,"unshare run")}async readRunSharedLink(e){I(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);I(e);const a=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});return await a.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),I(e);const r=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};I(e);const a=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)}),n=await a.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(e){I(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await S(t,"unshare dataset")}async readSharedDataset(e){I(e);const t=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});return await t.json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:n=null,referenceDatasetId:i=null}){const s=a?"?upsert=true":"",o=`${this.apiUrl}/sessions${s}`,l=n||{};r&&(l.metadata=r);const c={name:e,extra:l,description:t};null!==i&&(c.reference_dataset_id=i);const d=await this.caller.call(fetch,o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms)}),u=await d.json();if(!d.ok)throw new Error(`Failed to create session ${e}: ${d.status} ${d.statusText}`);return u}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:n=null,endTime:i=null}){const s=`${this.apiUrl}/sessions/${e}`;let o=n;a&&(o={...o||{},metadata:a});const l={name:t,extra:o,description:r,end_time:i?new Date(i).toISOString():null},c=await this.caller.call(fetch,s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),d=await c.json();if(!c.ok)throw new Error(`Failed to update project ${e}: ${c.status} ${c.statusText}`);return d}async readProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)I(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}const n=await this._get(r,a);let i;if(Array.isArray(n)){if(0===n.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=n[0]}else i=n;return i}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:n,referenceFree:i}={}){const s=new URLSearchParams;if(void 0!==e)for(const t of e)s.append("id",t);if(void 0!==t&&s.append("name",t),void 0!==r&&s.append("name_contains",r),void 0!==a)s.append("reference_dataset",a);else if(void 0!==n){const e=await this.readDataset({datasetName:n});s.append("reference_dataset",e.id)}void 0!==i&&s.append("reference_free",i.toString());for await(const e of this._getPaginated("/sessions",s))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,I(r);const a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await S(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:n,dataType:i,name:s}){const o=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach((e=>{l.append("input_keys",e)})),a.forEach((e=>{l.append("output_keys",e)})),n&&l.append("description",n),i&&l.append("data_type",i),s&&l.append("name",s);const c=await this.caller.call(fetch,o,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms)});if(!c.ok){const e=await c.json();if(e.detail&&e.detail.includes("already exists"))throw new Error(`Dataset ${t} already exists`);throw new Error(`Failed to upload CSV: ${c.status} ${c.statusText}`)}return await c.json()}async createDataset(e,{description:t,dataType:r}={}){const a={name:e,description:t};r&&(a.data_type=r);const n=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok){const t=await n.json();if(t.detail&&t.detail.includes("already exists"))throw new Error(`Dataset ${e} already exists`);throw new Error(`Failed to create dataset ${n.status} ${n.statusText}`)}return await n.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)I(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");a.append("name",t)}const n=await this._get(r,a);let i;if(Array.isArray(n)){if(0===n.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=n[0]}else i=n;return i}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:n}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)i.append("id",e);void 0!==a&&i.append("name",a),void 0!==n&&i.append("name_contains",n);for await(const e of this._getPaginated("/datasets",i))yield*e}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(a=(await this.readDataset({datasetName:t})).id),void 0===a)throw new Error("Must provide datasetName or datasetId");I(a),r+=`/${a}`;const n=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!n.ok)throw new Error(`Failed to delete ${r}: ${n.status} ${n.statusText}`);await n.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:n,exampleId:i}){let s=r;if(void 0===s&&void 0===a)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==a)throw new Error("Must provide either datasetName or datasetId, not both");void 0===s&&(s=(await this.readDataset({datasetName:a})).id);const o={dataset_id:s,inputs:e,outputs:t,created_at:(n||new Date).toISOString(),id:i},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms)});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map((e=>w(e)?b(e):e)),n=w(t)?b(t):t;return this.createExample({input:a},{output:n},r)}async readExample(e){I(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r}={}){let a;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)a=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");a=(await this.readDataset({datasetName:t})).id}const n=new URLSearchParams({dataset:a});if(void 0!==r)for(const e of r)n.append("id",e);for await(const e of this._getPaginated("/examples",n))yield*e}async deleteExample(e){I(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){I(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a}={loadChildRuns:!1}){let n,i;if("string"==typeof e)n=await this.readRun(e,{loadChildRuns:a});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);n=e}null!==n.reference_example_id&&void 0!==n.reference_example_id&&(i=await this.readExample(n.reference_example_id));const s=await t.evaluateRun(n,i);let o=r??{};return s.evaluatorInfo&&(o={...o,...s.evaluatorInfo}),await this.createFeedback(n.id,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,feedbackSourceType:"model"})}async createFeedback(e,t,{score:r,value:n,correction:i,comment:s,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:c,feedbackId:d,eager:u=!1}){const h={type:l??"api",metadata:o??{}};void 0===c||void 0===h?.metadata||h.metadata.__run||(h.metadata.__run={run_id:c}),void 0!==h?.metadata&&void 0!==h.metadata.__run?.run_id&&I(h.metadata.__run.run_id);const p={id:d??a.Z(),run_id:e,key:t,score:r,value:n,correction:i,comment:s,feedback_source:h},m=`${this.apiUrl}/feedback`+(u?"/eager":""),f=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms)});return await S(f,"create feedback"),p}async updateFeedback(e,{score:t,value:r,correction:a,comment:n}){const i={};null!=t&&(i.score=t),null!=r&&(i.value=r),null!=a&&(i.correction=a),null!=n&&(i.comment=n),I(e);const s=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms)});await S(s,"update feedback")}async readFeedback(e){I(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){I(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const e of t)a.append("key",e);if(r)for(const e of r)a.append("source",e);for await(const e of this._getPaginated("/feedback",a))yield*e}}const k=()=>"undefined"!=typeof Deno;let N;async function C(){if(void 0===N){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||k()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":k()?"deno":"other":"node",e})();N={library:"langchain-js",runtime:e}}return N}function $(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}class x extends s.Z{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??$("LANGCHAIN_PROJECT")??$("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new R({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await C()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async _persistRunSingle(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async _updateRunSingle(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs};await this.client.updateRun(e.id,t)}async onRetrieverStart(e){await this._persistRunSingle(e)}async onRetrieverEnd(e){await this._updateRunSingle(e)}async onRetrieverError(e){await this._updateRunSingle(e)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}}var L=r(13908);class M extends s.Z{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:$("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const e=$("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){const t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){const t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){const e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){const t=this.session??await this.loadDefaultSession(),r=e.serialized;let a;if("llm"===e.run_type){const n=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map((e=>(0,L.zs)(e)));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:n,response:e.outputs}}else if("chain"===e.run_type){const n=await Promise.all(e.child_runs.map((e=>this.convertV2RunToRun(e))));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:n.filter((e=>"llm"===e.type)),child_chain_runs:n.filter((e=>"chain"===e.type)),child_tool_runs:n.filter((e=>"tool"===e.type))}}else{if("tool"!==e.run_type)throw new Error(`Unknown run type: ${e.run_type}`);{const n=await Promise.all(e.child_runs.map((e=>this.convertV2RunToRun(e))));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:n.filter((e=>"llm"===e.type)),child_chain_runs:n.filter((e=>"chain"===e.type)),child_tool_runs:n.filter((e=>"tool"===e.type))}}}return a}async persistRun(e){let t,r;r=void 0!==e.run_type?await this.convertV2RunToRun(e):e,t="llm"===r.type?`${this.endpoint}/llm-runs`:"chain"===r.type?`${this.endpoint}/chain-runs`:`${this.endpoint}/tool-runs`;const a=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});a.ok||console.error(`Failed to persist run: ${a.status} ${a.statusText}`)}async persistSession(e){const t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){const t=await fetch(e,{method:"GET",headers:this.headers});let r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;const a=await t.json();return 0===a.length?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=a,this.session=r,r)}}let D;async function U(e,t){!0===t?await e():(void 0===D&&(D=new(0,m.default)({autoStart:!0,concurrency:1})),D.add(e))}function H(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class F{setHandler(e){return this.setHandlers([e])}}class B{constructor(e,t,r,a,n,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map((t=>U((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`)}}),t.awaitHandlers))))}}class J extends B{getChild(e){const t=new q(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${e}`)}}),t.awaitHandlers))))}}class G extends B{async handleLLMNewToken(e,t,r,a,n,i){await Promise.all(this.handlers.map((r=>U((async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`)}}),r.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`)}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`)}}),t.awaitHandlers))))}}class z extends B{getChild(e){const t=new q(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,n){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`)}}),t.awaitHandlers))))}async handleChainEnd(e,t,r,a,n){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`)}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`)}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`)}}),t.awaitHandlers))))}}class V extends B{getChild(e){const t=new q(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`)}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>U((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`)}}),t.awaitHandlers))))}}class q extends F{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}async handleLLMStart(e,t,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(t.map((async t=>{const r=(0,a.Z)();return await Promise.all(this.handlers.map((a=>U((async()=>{if(!a.ignoreLLM)try{await(a.handleLLMStart?.(e,[t],r,this._parentRunId,i,this.tags,this.metadata,l))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`)}}),a.awaitHandlers)))),new G(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(t.map((async t=>{const r=(0,a.Z)();return await Promise.all(this.handlers.map((a=>U((async()=>{if(!a.ignoreLLM)try{if(a.handleChatModelStart)await(a.handleChatModelStart?.(e,[t],r,this._parentRunId,i,this.tags,this.metadata,l));else if(a.handleLLMStart){const n=(0,L.zs)(t);await(a.handleLLMStart?.(e,[n],r,this._parentRunId,i,this.tags,this.metadata,l))}}catch(e){console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`)}}),a.awaitHandlers)))),new G(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,r=(0,a.Z)(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((a=>U((async()=>{if(!a.ignoreChain)try{await(a.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,n,o))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleChainStart: ${e}`)}}),a.awaitHandlers)))),new z(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=(0,a.Z)(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((a=>U((async()=>{if(!a.ignoreAgent)try{await(a.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleToolStart: ${e}`)}}),a.awaitHandlers)))),new V(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=(0,a.Z)(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map((a=>U((async()=>{if(!a.ignoreRetriever)try{await(a.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleRetrieverStart: ${e}`)}}),a.awaitHandlers)))),new J(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new q(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const a of e)r.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===a.name))||r.addHandler(a,t);return r}static fromHandlers(e){class t extends n.E{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,a.Z)()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,n,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new q,o.setHandlers(e?.map(K)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(K):t?.handlers,!1));const l="true"===$("LANGCHAIN_VERBOSE")||s?.verbose,c="true"===$("LANGCHAIN_TRACING_V2"),d=c||($("LANGCHAIN_TRACING")??!1);if(l||d){if(o||(o=new q),l&&!o.handlers.some((e=>e.name===u.prototype.name))){const e=new u;o.addHandler(e,!0)}if(d&&!o.handlers.some((e=>"langchain_tracer"===e.name)))if(c)o.addHandler(await async function(){return new x}(),!0);else{const e=$("LANGCHAIN_PROJECT")&&$("LANGCHAIN_SESSION");o.addHandler(await async function(e){const t=new M;return e?await t.loadSession(e):await t.loadDefaultSession(),t}(e),!0)}}return(r||a)&&o&&(o.addTags(r??[]),o.addTags(a??[],!1)),(n||i)&&o&&(o.addMetadata(n??{}),o.addMetadata(i??{},!1)),o}}function K(e){return"name"in e?e:n.E.fromMethods(e)}},36141:function(e,t,r){r.d(t,{i:function(){return c},j:function(){return l}});var a=r(2466);function n(e,t){return t?.[e]||a(e)}function i(e,t,r){const a={};for(const n in e)Object.hasOwn(e,n)&&(a[t(n,r)]=e[n]);return a}function s(e){return Array.isArray(e)?[...e]:{...e}}function o(e,t){const r=s(e);for(const[e,a]of Object.entries(t)){const[t,...n]=e.split(".").reverse();let i=r;for(const e of n.reverse()){if(void 0===i[e])break;i[e]=s(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[a]})}return r}function l(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}r(23204);class c{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,l(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof c||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,a=r;const[n,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in a&&void 0!==a[e]||("object"==typeof t[e]&&null!=t[e]?a[e]={}:Array.isArray(t[e])&&(a[e]=[])),t=t[e],a=a[e]}n in t&&void 0!==t[n]&&(a[n]=a[n]||t[n])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:i(Object.keys(t).length?o(r,t):r,n,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},13908:function(e,t,r){r.d(t,{E1:function(){return w},J:function(){return f},QW:function(){return g},gY:function(){return d},jN:function(){return h},ku:function(){return i},xk:function(){return l},zs:function(){return y}});var a=r(36141);function n(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?[...e,...t]:[...e,{type:"text",text:t}]}class i extends a.i{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if("human"===e)return new c({...this});if("ai"===e)return new u({...this});if("system"===e)return new p({...this});if("function"===e)return new m({...this});if(f.isInstance(this))return new b({...this});throw new Error("Unknown message type.")}}function s(e){return Array.isArray(e)&&e.every((e=>"number"==typeof e.index))}class o extends i{static _mergeAdditionalKwargs(e,t){const r={...e};for(const[e,a]of Object.entries(t))if(void 0===r[e])r[e]=a;else{if(typeof r[e]!=typeof a)throw new Error(`additional_kwargs[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e])r[e]=r[e]+a;else if(Array.isArray(r[e])||"object"!=typeof r[e]){if("tool_calls"!==e||!s(r[e])||!s(a))throw new Error(`additional_kwargs[${e}] already exists in this message chunk.`);for(const t of a)void 0!==r[e]?.[t.index]?r[e]=r[e]?.map(((e,r)=>r!==t.index?e:{...e,...t,function:{name:t.function.name??e.function.name,arguments:(e.function.arguments??"")+(t.function.arguments??"")}})):r[e][t.index]=t}else r[e]=this._mergeAdditionalKwargs(r[e],a)}return r}}class l extends i{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class c extends o{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new c({content:n(this.content,e.content),additional_kwargs:c._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class d extends i{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class u extends o{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new u({content:n(this.content,e.content),additional_kwargs:u._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class h extends i{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class p extends o{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new p({content:n(this.content,e.content),additional_kwargs:p._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class m extends o{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new m({content:n(this.content,e.content),additional_kwargs:m._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class f extends i{static lc_name(){return"ChatMessage"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}function g(e){return"function"==typeof e?._getType}function w(e){if("string"==typeof e)return new l(e);if(g(e))return e;const[t,r]=e;if("human"===t||"user"===t)return new l({content:r});if("ai"===t||"assistant"===t)return new d({content:r});if("system"===t)return new h({content:r});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class b extends o{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new b({content:n(this.content,e.content),additional_kwargs:b._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function y(e,t="Human",r="AI"){const a=[];for(const n of e){let e;if("human"===n._getType())e=t;else if("ai"===n._getType())e=r;else if("system"===n._getType())e="System";else if("function"===n._getType())e="Function";else if("tool"===n._getType())e="Tool";else{if("generic"!==n._getType())throw new Error(`Got unsupported message type: ${n._getType()}`);e=n.role}const i=n.name?`${n.name}, `:"";a.push(`${e}: ${i}${n.content}`)}return a.join("\n")}},11141:function(e,t,r){r.d(t,{GU:function(){return o},nw:function(){return s}});var a=r(36141),n=r(13908);class i extends a.i{}class s extends i{constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new n.xk(this.value)]}}class o extends i{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,n.zs)(this.messages)}toChatMessages(){return this.messages}}},52399:function(e,t,r){r.d(t,{eq:function(){return x}});var a={};r.r(a),r.d(a,{JsonPatchError:function(){return p},_areEquals:function(){return O},applyOperation:function(){return b},applyPatch:function(){return y},applyReducer:function(){return _},deepClone:function(){return m},getValueByPointer:function(){return w},validate:function(){return E},validator:function(){return v}});var n=r(42693),i=r(75290);const s=Object.prototype.hasOwnProperty;function o(e,t){return s.call(e,t)}function l(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function c(e){let t=0;const r=e.length;let a;for(;t<r;){if(a=e.charCodeAt(t),!(a>=48&&a<=57))return!1;t++}return!0}function d(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(d(e[t]))return!0}else if("object"==typeof e){const r=function(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)o(e,r)&&t.push(r);return t}(e),a=r.length;for(var t=0;t<a;t++)if(d(e[r[t]]))return!0}return!1}function u(e,t){const r=[e];for(const e in t){const a="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==a&&r.push(`${e}: ${a}`)}return r.join("\n")}class h extends Error{constructor(e,t,r,a,n){super(u(e,{name:t,index:r,operation:a,tree:n})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.setPrototypeOf(this,new.target.prototype),this.message=u(e,{name:t,index:r,operation:a,tree:n})}}const p=h,m=l,f={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var a=e[t];return delete e[t],{newDocument:r,removed:a}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:function(e,t,r){let a=w(r,this.path);a&&(a=l(a));const n=b(r,{op:"remove",path:this.from}).removed;return b(r,{op:"add",path:this.path,value:n}),{newDocument:r,removed:a}},copy:function(e,t,r){const a=w(r,this.from);return b(r,{op:"add",path:this.path,value:l(a)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:O(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var g={add:function(e,t,r){return c(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:f.move,copy:f.copy,test:f.test,_get:f._get};function w(e,t){if(""==t)return e;var r={op:"_get",path:t};return b(e,r),r.value}function b(e,t,r=!1,a=!0,n=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):v(t,0)),""===t.path){let a={newDocument:e};if("add"===t.op)return a.newDocument=t.value,a;if("replace"===t.op)return a.newDocument=t.value,a.removed=e,a;if("move"===t.op||"copy"===t.op)return a.newDocument=w(e,t.from),"move"===t.op&&(a.removed=e),a;if("test"===t.op){if(a.test=O(e,t.value),!1===a.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a.newDocument=e,a}if("remove"===t.op)return a.removed=e,a.newDocument=null,a;if("_get"===t.op)return t.value=e,a;if(r)throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return a}{a||(e=l(e));const s=(t.path||"").split("/");let o,d,u,h=e,m=1,w=s.length;for(u="function"==typeof r?r:v;;){if(d=s[m],d&&-1!=d.indexOf("~")&&(d=d.replace(/~1/g,"/").replace(/~0/g,"~")),n&&("__proto__"==d||"prototype"==d&&m>0&&"constructor"==s[m-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===o&&(void 0===h[d]?o=s.slice(0,m).join("/"):m==w-1&&(o=t.path),void 0!==o&&u(t,0,e,o)),m++,Array.isArray(h)){if("-"===d)d=h.length;else{if(r&&!c(d))throw new p("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);c(d)&&(d=~~d)}if(m>=w){if(r&&"add"===t.op&&d>h.length)throw new p("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const a=g[t.op].call(t,h,d,e);if(!1===a.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a}}else if(m>=w){const r=f[t.op].call(t,h,d,e);if(!1===r.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(h=h[d],r&&m<w&&(!h||"object"!=typeof h))throw new p("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function y(e,t,r,a=!0,n=!0){if(r&&!Array.isArray(t))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");a||(e=l(e));const i=new Array(t.length);for(let a=0,s=t.length;a<s;a++)i[a]=b(e,t[a],r,!0,n,a),e=i[a].newDocument;return i.newDocument=e,i}function _(e,t,r){const a=b(e,t);if(!1===a.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return a.newDocument}function v(e,t,r,a){if("object"!=typeof e||null===e||Array.isArray(e))throw new p("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!f[e.op])throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new p("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new p('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new p("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&d(e.value))throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var n=e.path.split("/").length,i=a.split("/").length;if(n!==i+1&&n!==i)throw new p("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==a)throw new p("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=E([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new p("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function E(e,t,r){try{if(!Array.isArray(e))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)y(l(t),l(e),r||!0);else{r=r||v;for(var a=0;a<e.length;a++)r(e[a],a,t,void 0)}}catch(e){if(e instanceof p)return e;throw e}}function O(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,a,n,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((a=e.length)!=t.length)return!1;for(r=a;0!=r--;)if(!O(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((a=o.length)!==Object.keys(t).length)return!1;for(r=a;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=a;0!=r--;)if(!O(e[n=o[r]],t[n]))return!1;return!0}return e!=e&&t!=t}new WeakMap;var T=r(84075);class S extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done&&this.reader.releaseLock(),{done:e.done,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new S({start(e){return function r(){return t.read().then((({done:t,value:a})=>{if(!t)return e.enqueue(a),r();e.close()}))}()},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new S({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)}})}}class A{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops}concat(e){const t=this.ops.concat(e.ops),r=y({},t);return new j({ops:t,state:r[r.length-1].newDocument})}}class j extends A{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=y(this.state,e.ops);return new j({ops:t,state:r[r.length-1].newDocument})}}class P extends T.Z{constructor(e){super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=S.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(void 0===e.parent_run_id)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async onRunCreate(e){if(void 0===e.parent_run_id&&await this.writer.write(new A({ops:[{op:"replace",path:"",value:{id:e.id,streamed_output:[],final_output:void 0,logs:{}}}]})),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output_str:[],final_output:void 0,end_time:void 0};await this.writer.write(new A({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[{op:"add",path:`/logs/${t}/final_output`,value:e.outputs}];void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new A({ops:r});await this.writer.write(a)}finally{if(void 0===e.parent_run_id){const t=new A({ops:[{op:"replace",path:"/final_output",value:e.outputs}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t){const r=this.keyMapByRunId[e.id];if(void 0===r)return;const a=new A({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t}]});await this.writer.write(a)}}var I=r(36141);async function R(e){return i.Ye.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function k(e,t){const r={...e};if(t)for(const a of Object.keys(t))if("metadata"===a)r[a]={...r[a],...t[a]};else if("tags"===a)r[a]=(r[a]??[]).concat(t[a]??[]);else if("callbacks"===a){const a=r.callbacks,n=t.callbacks??e.callbacks;if(Array.isArray(n))if(a)if(Array.isArray(a))r.callbacks=a.concat(n);else{const e=a.copy();for(const t of n)e.addHandler(t,!0);r.callbacks=e}else r.callbacks=n;else if(n)if(a)if(Array.isArray(a)){const e=n.copy();for(const t of a)e.addHandler(t,!0);r.callbacks=e}else r.callbacks=new i.Ye(n.parentRunId,{handlers:a.handlers.concat(n.handlers),inheritableHandlers:a.inheritableHandlers.concat(n.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(n.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(n.inheritableTags))),metadata:{...a.metadata,...n.metadata}});else r.callbacks=n}else r[a]=t[a]??r[a];return r}var N=r(99636);class C extends T.Z{constructor({config:e,onStart:t,onEnd:r,onError:a}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function $(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class x extends I.i{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}bind(e){return new L({bound:this,kwargs:e,config:{}})}map(){return new M({bound:this})}withRetry(e){return new D({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new L({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new B({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e}return Array.from({length:t},(()=>e))}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=new N.L({maxConcurrency:r?.maxConcurrency,onFailedAttempt:e=>{throw e}}),i=e.map(((e,t)=>n.call((async()=>{try{return await this.invoke(e,a[t])}catch(e){if(r?.returnExceptions)return e;throw e}}))));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){return S.fromAsyncGenerator(this._streamIterator(e,t))}_separateRunnableConfigFromCallOptions(e={}){const t={callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName},r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,[t,r]}async _callWithConfig(e,t,r){const a=await R(r),n=await(a?.handleChainStart(this.toJSON(),$(t,"input"),void 0,r?.runType,void 0,void 0,r?.runName));let i;try{i=await e.bind(this)(t,r,n)}catch(e){throw await(n?.handleChainError(e)),e}return await(n?.handleChainEnd($(i,"output"))),i}async _batchWithConfig(e,t,r,a){const n=this._getOptionsList(r??{},t.length),i=await Promise.all(n.map(R)),s=await Promise.all(i.map(((e,r)=>e?.handleChainStart(this.toJSON(),$(t[r],"input"),void 0,n[r].runType,void 0,void 0,n[r].runName))));let o;try{o=await e(t,n,s,a)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd($(o,"output"))))),o}async*_transformStreamWithConfig(e,t,r){let a,n,i=!0,s=!0;const o=await R(r);let l;const c=this.toJSON(),d=async function*(){for await(const t of e){if(l||(l=await(o?.handleChainStart(c,{input:""},void 0,r?.runType,void 0,void 0,r?.runName))),i)if(void 0===a)a=t;else try{a=a.concat(t)}catch{a=void 0,i=!1}yield t}}();try{const e=t(d,l,r);for await(const t of e)if(yield t,s)if(void 0===n)n=t;else try{n=n.concat(t)}catch{n=void 0,s=!1}}catch(e){throw await(l?.handleChainError(e,void 0,void 0,void 0,{inputs:$(a,"input")})),e}await(l?.handleChainEnd(n??{},void 0,void 0,void 0,{inputs:$(a,"input")}))}_patchConfig(e={},t=void 0){const r={...e};return void 0!==t?(delete r.runName,{...r,callbacks:t}):r}pipe(e){return new U({first:this,last:J(e)})}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:r.concat(t);yield*this._streamIterator(r,t)}async*streamLog(e,t,r){const a=new P({...r,autoClose:!1}),n=t??{},{callbacks:i}=n;if(void 0===i)n.callbacks=[a];else if(Array.isArray(i))n.callbacks=i.concat([a]);else{const e=i.copy();e.inheritableHandlers.push(a),n.callbacks=e}const s=await this.stream(e,n),o=async function(){try{for await(const e of s){const t=new A({ops:[{op:"add",path:"/streamed_output/-",value:e}]});await a.writer.write(t)}}finally{await a.writer.close()}}();try{for await(const e of a)yield e}finally{await o}}static isRunnable(e){return!!e&&e.lc_runnable}withListeners({onStart:e,onEnd:t,onError:r}){return new L({bound:this,config:{},configFactories:[a=>({callbacks:[new C({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class L extends x{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}async _mergeConfig(e){const t=k(this.config,e);return k(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig({...t,...this.kwargs}))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig({...e,...this.kwargs})))):await this._mergeConfig({...t,...this.kwargs});return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig({...t,...this.kwargs}))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig({...t,...this.kwargs}))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig({...t,...this.kwargs}))}static isRunnableBinding(e){return e.bound&&x.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new L({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new C({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class M extends x{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new M({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,this._patchConfig(t,r?.getChild()))}withListeners({onStart:e,onEnd:t,onError:r}){return new M({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class D extends L{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return this._patchConfig(t,r?.getChild(a))}async _invoke(e,t,r){return n((a=>super.invoke(e,this._patchConfigForRetry(a,t,r))),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){const i={};try{await n((async n=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error)),o=s.map((t=>e[t])),l=s.map((e=>this._patchConfigForRetry(n,t?.[e],r?.[e]))),c=await super.batch(o,l,{...a,returnExceptions:!0});let d;for(let e=0;e<c.length;e+=1){const t=c[e],r=s[e];t instanceof Error&&void 0===d&&(d=t),i[r.toString()]=t}if(d)throw d;return c}),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==a?.returnExceptions)throw e}return Object.keys(i).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>i[parseInt(e,10)]))}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class U extends x{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=await R(t),a=await(r?.handleChainStart(this.toJSON(),$(e,"input"),void 0,void 0,void 0,void 0,t?.runName));let n,i=e;try{const e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){const n=e[r];i=await n.invoke(i,this._patchConfig(t,a?.getChild(`seq:step:${r+1}`)))}n=await this.last.invoke(i,this._patchConfig(t,a?.getChild(`seq:step:${this.steps.length}`)))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd($(n,"output"))),n}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map(R)),i=await Promise.all(n.map(((t,r)=>t?.handleChainStart(this.toJSON(),$(e[r],"input"),void 0,void 0,void 0,void 0,a[r].runName))));let s,o=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const n=e[t];o=await n.batch(o,i.map(((e,r)=>this._patchConfig(a[r],e?.getChild(`seq:step:${t+1}`)))),r)}s=await this.last.batch(o,i.map((e=>this._patchConfig(a[this.steps.length-1],e?.getChild(`seq:step:${this.steps.length}`)))),r)}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map(((e,t)=>e?.handleChainEnd($(s[t],"output"))))),s}async*_streamIterator(e,t){const r=await R(t),a=await(r?.handleChainStart(this.toJSON(),$(e,"input"),void 0,void 0,void 0,void 0,t?.runName)),n=[this.first,...this.middle,this.last];let i,s=!0;try{let r=n[0].transform(async function*(){yield e}(),this._patchConfig(t,a?.getChild("seq:step:1")));for(let e=1;e<n.length;e+=1){const i=n[e];r=await i.transform(r,this._patchConfig(t,a?.getChild(`seq:step:${e+1}`)))}for await(const e of r)if(yield e,s)if(void 0===i)i=e;else try{i=i.concat(e)}catch(e){i=void 0,s=!1}}catch(e){throw await(a?.handleChainError(e)),e}await(a?.handleChainEnd($(i,"output")))}pipe(e){return U.isRunnableSequence(e)?new U({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last}):new U({first:this.first,middle:[...this.middle,this.last],last:J(e)})}static isRunnableSequence(e){return Array.isArray(e.middle)&&x.isRunnable(e)}static from([e,...t]){return new U({first:J(e),middle:t.slice(0,-1).map(J),last:J(t[t.length-1])})}}class H extends x{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=J(r)}static from(e){return new H({steps:e})}async invoke(e,t){const r=await R(t),a=await(r?.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,t?.runName)),n={};try{await Promise.all(Object.entries(this.steps).map((async([r,i])=>{n[r]=await i.invoke(e,this._patchConfig(t,a?.getChild(r)))})))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(n)),n}}class F extends x{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new F({func:e})}async _invoke(e,t,r){let a=await this.func(e,{config:t});return a&&x.isRunnable(a)&&(a=await a.invoke(e,this._patchConfig(t,r?.getChild()))),a}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}}class B extends x{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await i.Ye.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),a=await(r?.handleChainStart(this.toJSON(),$(e,"input"),void 0,void 0,void 0,void 0,t?.runName));let n;for(const r of this.runnables())try{const n=await r.invoke(e,this._patchConfig(t,a?.getChild()));return await(a?.handleChainEnd($(n,"output"))),n}catch(e){void 0===n&&(n=e)}if(void 0===n)throw new Error("No error stored at end of fallback.");throw await(a?.handleChainError(n)),n}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map((e=>i.Ye.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)))),s=await Promise.all(n.map(((t,r)=>t?.handleChainStart(this.toJSON(),$(e[r],"input"),void 0,void 0,void 0,void 0,a[r].runName))));let o;for(const t of this.runnables())try{const n=await t.batch(e,s.map(((e,t)=>this._patchConfig(a[t],e?.getChild()))),r);return await Promise.all(s.map(((e,t)=>e?.handleChainEnd($(n[t],"output"))))),n}catch(e){void 0===o&&(o=e)}if(!o)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map((e=>e?.handleChainError(o)))),o}}function J(e){if("function"==typeof e)return new F({func:e});if(x.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,a]of Object.entries(e))t[r]=J(a);return new H({steps:t})}}},84075:function(e,t,r){r.d(t,{Z:function(){return i}});var a=r(16515);function n(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class i extends a.E{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){if(void 0!==e.parent_run_id){const t=this.runMap.get(e.parent_run_id);t&&(this._addChildRun(t,e),t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order))}this.runMap.set(e.id,e),await(this.onRunCreate?.(e))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,n,i,s,o){const l=this._getExecutionOrder(a),c=Date.now(),d=s?{...n,metadata:s}:n,u={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(u),await(this.onLLMStart?.(u)),u}async handleChatModelStart(e,t,r,a,n,i,s,o){const l=this._getExecutionOrder(a),c=Date.now(),d=s?{...n,metadata:s}:n,u={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:d??{},tags:i||[]};return await this._startTrace(u),await(this.onLLMStart?.(u)),u}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onLLMEnd?.(r)),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onLLMError?.(r)),await this._endTrace(r),r}async handleChainStart(e,t,r,a,n,i,s,o){const l=this._getExecutionOrder(a),c=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(d),await(this.onChainStart?.(d)),d}async handleChainEnd(e,t,r,a,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=n(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=n(i.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,r,a,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=e.message,s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=n(i.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}async handleToolStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(c),await(this.onToolStart?.(c)),c}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||"chain"!==r?.run_type)return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}async handleRetrieverStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(c),await(this.onRetrieverStart?.(c)),c}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,a,n,i){const s=this.runMap.get(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e)),s}}},99636:function(e,t,r){r.d(t,{L:function(){return o}});var a=r(42693),n=r(45860);const i=[400,401,402,403,404,405,406,407,408,409],s=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&i.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??s;const t=n.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>a((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}}}]);
//# sourceMappingURL=919.js.map